{# templates/calendar/day.html — FINAL PERFECTION — SIDEBAR WITH PERFECT BREATHING ROOM #}
{% include "shared/task_modal.html" %}
<div class="max-w-7xl mx-auto">
  <h2 class="text-6xl font-black text-gold mb-8 text-center drop-shadow-lg">
    {{ month|month_name }} {{ day }}, {{ year }}
  </h2>

  <!-- MAIN GRID — 3:1 RATIO, CLEAN GAP -->
  <div class="mt-20 grid grid-cols-1 md:grid-cols-4 gap-8">
    
    <!-- LEFT: TIME GRID — NOW WITH COLLAPSE DOMINATION -->
    <div class="md:col-span-3"> {# Takes 3/4 on desktop, full on mobile #}
      <!-- COLLAPSIBLE HEADER BAR — ALWAYS VISIBLE, BECOMES THE COLLAPSED STATE -->
      <div id="calendar-toggle-header"
           class="p-6 bg-black border-4 border-yellow-400 rounded-xl cursor-pointer select-none flex items-center justify-between shadow-heavy hover:bg-gray-900 transition-all"
           data-action="toggle-calendar">
        <div class="flex items-center gap-4">
          <span id="calendar-toggle-icon" class="text-gold font-bold text-3xl">▼</span>
          <h3 class="text-4xl font-black text-gold drop-shadow-lg">DAILY TIME GRID</h3>
        </div>
        <span class="text-gray-400 text-lg">5:00 AM – 10:30 PM</span>
      </div>

      <!-- EXPANDED GRID -->
      <div id="calendar-grid-expanded" class="border-x-4 border-b-4 border-yellow-400 rounded-b-xl overflow-hidden shadow-heavy bg-black">
        <div class="grid grid-cols-12 gap-0">
          <!-- TIME LABELS -->
          <div class="col-span-1 bg-dark">
            {% for slot in range(38) %}
              {% set hour = 5 + (slot // 2) %}
              {% set minute = (slot % 2) * 30 %}
              {% set hour_12 = ((hour - 1) % 12) + 1 %}
              {% set am_pm = 'AM' if hour < 12 else 'PM' %}

              <div class="h-32 border-b border-gray-700 flex items-center justify-end pr-5">
                {% if minute == 0 %}
                  <span class="text-gold text-lg">{{ "%d:00"|format(hour_12) }}</span>
                  <span class="text-gold text-sm ml-2">{{ am_pm }}</span>
                {% else %}
                  <span class="text-gray-500 text-lg">{{ "%d:%02d"|format(hour_12, minute) }}</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          <!-- TIME SLOTS -->
          <div class="col-span-11 bg-gray-950">
            <div class="grid grid-rows-38 h-full">
              {% for slot in range(38) %}
                <div class="border-b border-gray-700 relative group cursor-pointer" data-slot="{{ slot }}">
                  <div class="event-container"></div>
                  <div class="absolute inset-0 hover:bg-yellow-900/30 transition-all"></div>
                  <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    <span class="text-2xl font-black text-gold drop-shadow-lg">
                      {% set hour = 5 + (slot // 2) %}
                      {% set minute = (slot % 2) * 30 %}
                      {% set hour_12 = ((hour - 1) % 12) + 1 %}
                      {% set am_pm = 'AM' if hour < 12 else 'PM' %}
                      {{ "%d:%02d %s"|format(hour_12, minute, am_pm) }}
                    </span>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- COLLAPSED PLACEHOLDER -->
      <div id="calendar-grid-collapsed"
           class="hidden p-8 bg-black border-4 border-yellow-400 rounded-xl cursor-pointer select-none text-center shadow-heavy hover:bg-gray-900 transition-all"
           data-action="toggle-calendar">
      </div>
    </div>
    <!-- LEFT: TIME GRID -->
  </div>
      <!-- TASKS KANBAN — FULL WIDTH, CENTERED -->
    <div class="mt-20">
      <div class="max-w-7xl mx-auto">
      <h3 class="text-4xl font-black text-gold text-center mb-12">TODAY'S TASKS</h3>

      <!-- Floating + button — same as global tasks page -->
      <button id="add-task-btn"
              class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold text-4xl w-20 h-20 rounded-full shadow-2xl transition-all hover:scale-110 fixed bottom-8 right-8 z-50">
        +
      </button>  

        {% set final_task_statuses = [] %}
        {% for s in task_statuses %}
          {% if s.value != 'backlog' %}
            {% set _ = final_task_statuses.append(s) %}
          {% endif %}
        {% endfor %}
        {% with
          kanban_id="day-tasks-kanban",
          kanban_statuses=final_task_statuses,
          kanban_type="task"
        %}
          {% include "shared/kanban.html" %}
        {% endwith %}
      </div>
    </div>
</div>

