{# templates/calendar/month.html — FINAL SUNDAY-FIRST GRID, NO FILTERS, PURE PROTEIN #}


{% block date_str %}
{{ year }}-{{ '%02d'|format(month) }}-01
{% endblock %}
<div class="max-w-5xl mx-auto">
  <h2 class="text-5xl font-black text-gold mb-8 text-center drop-shadow-lg">
    {{ month|month_name }} {{ year }}
  </h2>

  <!-- WEEKDAY HEADER — FIXED WITH grid-cols-7 -->
  <div class="week-grid-8 gap-4 text-center font-bold text-muted mb-6 uppercase tracking-wider">
    <div>WK</div><div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
  </div>

  <!-- MAIN GRID — THIS IS THE MONEY: grid-cols-7, gap-6, aspect-square -->
  <div class="week-grid-8 gap-6 text-2xl font-bold">
    {# SIMPLE SUNDAY-FIRST OFFSET (0 = Sunday) #}
    {# CORRECT: Check if the 1st of THIS month is Sunday #}
    {% set jan1_weekday = (year * 365 + year//4 - year//100 + year//400 + [0,31,59,90,120,151,181,212,243,273,304,334][month-1]) % 7 %}
    {% set first_day_wd = year|first_day_weekday(month) %}
    {% if first_day_wd != 6 %}
      {% set start_offset = jan1_weekday + 1 %}
      {% set blank_offset = start_offset - 1 %}
      {% set dow_offset = start_offset - 2 %}

        <a href="{{ url_for('calendar.calendar_view', view='week', year=year, month=month, day=day) }}"
              class="aspect-square flex items-center justify-center rounded-xl bg-card hover:bg-gray-700 transition-all hover-grow text-cyan-400 font-black border-2 border-transparent hover:border-cyan-500">
              {{ year|iso_week(month, 1) }}
        </a>

    {% else %}
      {% set start_offset = 0 %}
      {% set blank_offset = start_offset %}
      {% set dow_offset = start_offset - 1 %}
    {% endif %}

    <!-- Leading blanks -->
    {% for _ in range(blank_offset) %}
      <div class="aspect-square"></div>
    {% endfor %}

    <!-- Days of the month -->
    {% for day in range(1, year|days_in_month(month) + 1) %}

      {% set day_of_week = (day + dow_offset) % 7 %}

      <!-- WEEK NUMBER — ISO COMPLIANT — ONLY ON SUNDAY -->
      {% if day_of_week == 0 %}
        
        <a href="{{ url_for('calendar.calendar_view', view='week', year=year, month=month, day=day) }}"
           class="aspect-square flex items-center justify-center rounded-xl bg-card hover:bg-gray-700 transition-all hover-grow text-cyan-400 font-black border-2 border-transparent hover:border-cyan-500">
          {{ year|iso_week(month, day + 1) }}
        </a>
      
      {% endif %}  

      {% set is_today = (year == now.year and month == now.month and day == now.day) %}
      <a href="{{ url_for('calendar.calendar_view', view='day', year=year, month=month, day=day) }}"
         class="aspect-square flex items-center justify-center rounded-xl transition-all hover:bg-card hover:scale-110
                {% if is_today %}
                  bg-dark border-4 border-yellow-400 shadow-heavy shadow-yellow-400/50 text-gold font-black
                {% else %}
                  bg-card text-gray-300
                {% endif %}">
        {{ day }}
      </a>
    {% endfor %}
  </div>
</div>